{% extends "layout.twig" %}

{% block content %}
  <style>
    .share {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    .share__viewer {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .share__iframe {
      width: 100%;
      height: 60vh;
      border: 1px solid #eadfce;
      border-radius: 10px;
      background: #fffaf2;
    }
  </style>

  <div class="card share">
    <form method="post" action="{{ base_path }}/share">
      <input type="hidden" name="_csrf" value="{{ csrf }}" />
      <label>
        Paste a link
        <input type="url" name="url" style="width: 100%;" placeholder="https://example.com/article" value="{{ selected ? selected.url : '' }}" required />
      </label>
      <br /><br />
      <button type="submit">Preview</button>
      {% if error %}
        <span class="muted" style="margin-left: 8px;">{{ error }}</span>
      {% endif %}
    </form>

    <div class="share__viewer">
      {% if selected %}
        {% if status == 'shared' %}
          <div class="card" style="margin-bottom: 12px;">
            <p class="muted">Article shared.</p>
          </div>
        {% elseif status == 'rate_limited' %}
          <div class="card" style="margin-bottom: 12px;">
            <p class="muted">Article scheduled (rate limit).</p>
          </div>
        {% elseif status == 'scheduled' %}
          <div class="card" style="margin-bottom: 12px;">
            <p class="muted">Article scheduled.</p>
          </div>
        {% elseif status == 'failed' %}
          <div class="card" style="margin-bottom: 12px;">
            <p class="muted">Share failed. Check account settings.</p>
          </div>
        {% endif %}
        {% if post_details %}
          <div class="card" style="margin-bottom: 12px;">
            <p class="muted">Per network:</p>
            <ul style="margin: 8px 0 0 16px;">
              {% for row in post_details %}
                <li class="muted">
                  {{ row.platform }} — {{ row.status }}
                  {% if row.status == 'failed' and row.error %}
                    ({{ row.error }})
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
        {% if error %}
          <div class="card" style="margin-bottom: 12px;">
            <p class="muted">Please add a comment, schedule time, and at least one account.</p>
          </div>
        {% endif %}
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <strong>{{ selected.title }}</strong>
          </div>
          <div>
            {% if mode == 'reader' %}
              <span class="muted">Reader</span>
              <span class="muted" style="margin: 0 6px;">·</span>
                <a href="{{ base_path }}/share?selected={{ selected.id }}&mode=original">Original</a>
            {% else %}
              <a href="{{ base_path }}/share?selected={{ selected.id }}&mode=reader">Reader</a>
              <span class="muted" style="margin: 0 6px;">·</span>
              <span class="muted">Original</span>
            {% endif %}
            <span class="muted" style="margin: 0 6px;">·</span>
            <a href="{{ selected.url }}" target="_blank" rel="noopener">Open in new tab</a>
          </div>
        </div>

        {% if mode == 'original' %}
          <iframe class="share__iframe" src="{{ selected.url }}" title="{{ selected.title }}"></iframe>
        {% else %}
          <iframe class="share__iframe" src="{{ base_path }}/articles/{{ selected.id }}/embed" title="{{ selected.title }}"></iframe>
        {% endif %}

        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <strong>Schedule</strong>
          </div>
          <form method="post" action="{{ base_path }}/posts">
            <input type="hidden" name="_csrf" value="{{ csrf }}" />
            <input type="hidden" name="article_id" value="{{ selected.id }}" />
            <input type="hidden" name="return_to" value="{{ base_path }}/share?selected={{ selected.id }}&mode={{ mode }}" />
            <label>
              Comment
              <textarea id="share-comment" name="comment" rows="4" style="width: 100%;"></textarea>
            </label>
            <div class="muted" style="font-size: 12px;">
              Length: <span id="share-comment-length">0</span>
            </div>
            <div style="margin-top: 6px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
              <label>
                Generate
                <select id="share-generate-mode">
                  <option value="comment">Comment</option>
                  <option value="summary">Summary</option>
                  <option value="phrase">Impactful phrase</option>
                </select>
              </label>
              <button type="button" data-generate-comment data-article-id="{{ selected.id }}">Generate</button>
              <span class="muted" data-comment-status></span>
            </div>
            <br /><br />
            <label>
              Schedule
              <input id="share-schedule" type="datetime-local" name="scheduled_at" />
            </label>
            <br /><br />
            <fieldset style="border: 0; padding: 0; margin: 0;">
              <legend>Accounts</legend>
              {% if accounts|length == 0 %}
                <p class="muted">No active accounts yet.</p>
              {% else %}
                {% for account in accounts %}
                  <label style="display: block;">
                    <input type="checkbox" name="account_ids[]" value="{{ account.id }}" />
                    {{ account.platform }} · {{ account.display_name }} ({{ account.handle }})
                  </label>
                {% endfor %}
              {% endif %}
            </fieldset>
            <br />
            <button type="submit" name="action" value="schedule">Schedule</button>
            <button type="submit" name="action" value="now" style="margin-left: 6px;">Share now</button>
          </form>
        </div>
      {% else %}
        <div class="muted" style="padding: 24px; border: 1px dashed #eadfce; border-radius: 10px;">
          Paste a link above to preview and schedule.
        </div>
      {% endif %}
    </div>
  </div>

  <script>
    (function () {
      var button = document.querySelector('[data-generate-comment]');
      if (!button) return;
      var status = document.querySelector('[data-comment-status]');
      var textarea = document.getElementById('share-comment');
      var csrf = '{{ csrf }}';
      var basePath = '{{ base_path }}';
      var modeSelect = document.getElementById('share-generate-mode');
      var lengthEl = document.getElementById('share-comment-length');
      var scheduleInput = document.getElementById('share-schedule');

      if (scheduleInput && !scheduleInput.value) {
        var now = new Date(Date.now() + 5 * 60 * 1000);
        scheduleInput.value = now.toISOString().slice(0, 16);
      }

      button.addEventListener('click', function () {
        var articleId = button.getAttribute('data-article-id');
        if (!articleId || !textarea) return;
        button.disabled = true;
        if (status) status.textContent = 'Generating...';
        var body = new URLSearchParams();
        body.set('_csrf', csrf);
        if (modeSelect && modeSelect.value) {
          body.set('mode', modeSelect.value);
        }
        fetch(basePath + '/articles/' + articleId + '/comment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: body.toString()
        })
          .then(function (res) { return res.text(); })
          .then(function (text) {
            textarea.value = text;
            if (lengthEl) lengthEl.textContent = String(text.length);
            if (status) status.textContent = '';
          })
          .catch(function () {
            if (status) status.textContent = 'Failed to generate.';
          })
          .finally(function () {
            button.disabled = false;
          });
      });

      if (textarea && lengthEl) {
        textarea.addEventListener('input', function () {
          lengthEl.textContent = String(textarea.value.length);
        });
      }
    })();
  </script>
{% endblock %}
