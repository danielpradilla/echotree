{% extends "layout.twig" %}

{% block content %}
  <style>
    .inbox {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 20px;
    }
    .inbox__list {
      border-right: 1px solid #eadfce;
      padding-right: 12px;
      max-height: calc(100vh - 220px);
      overflow: auto;
    }
    .inbox__item {
      padding: 10px 8px;
      border-bottom: 1px solid #efe4d6;
    }
    .inbox__item a { text-decoration: none; }
    .inbox__item.active { background: #fff7e8; border-radius: 8px; }
    .inbox__viewer {
      display: flex;
      flex-direction: column;
      gap: 16px;
      min-height: 400px;
    }
    .inbox__iframe {
      width: 100%;
      height: 60vh;
      border: 1px solid #eadfce;
      border-radius: 10px;
      background: #fffaf2;
    }
    @media (max-width: 900px) {
      .inbox { grid-template-columns: 1fr; }
      .inbox__list { max-height: none; border-right: 0; padding-right: 0; }
      .inbox__iframe { height: 50vh; }
      .inbox__toggle { display: inline-flex; }
      .inbox__list.is-collapsed { display: none; }
    }
  </style>

  <div class="card">
    <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
      <button type="button" class="inbox__toggle" style="display: none;">Show list</button>
    </div>
    <div class="inbox" style="margin-top: 12px;">
      <div class="inbox__list">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <form method="get" action="{{ base_path }}/articles">
            <label>
              Feed
              <select name="feed_id" onchange="this.form.submit()">
                <option value="">All</option>
                {% for feed in feeds %}
                  <option value="{{ feed.id }}" {% if active_feed_id == feed.id %}selected{% endif %}>
                    {{ feed.name }}
                  </option>
                {% endfor %}
              </select>
            </label>
          </form>
          <form method="post" action="{{ base_path }}/articles/mark-all-read">
            <input type="hidden" name="_csrf" value="{{ csrf }}" />
            {% if active_feed_id %}
              <input type="hidden" name="feed_id" value="{{ active_feed_id }}" />
            {% endif %}
            <button type="submit">Mark all read</button>
          </form>
        </div>

        {% if articles|length == 0 %}
          <p class="muted">No articles yet.</p>
        {% else %}
          {% for article in articles %}
            {% set is_selected = selected and selected.id == article.id %}
            <div class="inbox__item {% if is_selected %}active{% endif %}">
              <div>
                <a href="{{ base_path }}/articles?{% if active_feed_id %}feed_id={{ active_feed_id }}&{% endif %}selected={{ article.id }}">
                  <strong>{{ article.title }}</strong>
                </a>
              </div>
              <div class="muted" style="font-size: 12px;">
                {{ article.feed_name }} · {{ article.published_at ?: article.created_at }} ·
                {% if article.is_read %}read{% else %}unread{% endif %}
              </div>
              <div style="margin-top: 6px;">
                <a href="{{ article.url }}" target="_blank" rel="noopener">Original</a>
                <form method="post" action="{{ base_path }}/articles/{{ article.id }}/toggle-read" style="display: inline; margin-left: 8px;">
                  <input type="hidden" name="_csrf" value="{{ csrf }}" />
                  <button type="submit">{{ article.is_read ? 'Mark unread' : 'Mark read' }}</button>
                </form>
              </div>
            </div>
          {% endfor %}
        {% endif %}
      </div>

      <div class="inbox__viewer">
        {% if selected %}
          {% if status == 'shared' %}
            <div class="card" style="margin-bottom: 12px;">
              <p class="muted">Article shared.</p>
            </div>
          {% elseif status == 'rate_limited' %}
            <div class="card" style="margin-bottom: 12px;">
              <p class="muted">Article scheduled (rate limit).</p>
            </div>
          {% elseif status == 'scheduled' %}
            <div class="card" style="margin-bottom: 12px;">
              <p class="muted">Article scheduled.</p>
            </div>
          {% elseif status == 'failed' %}
            <div class="card" style="margin-bottom: 12px;">
              <p class="muted">Share failed. Check account settings.</p>
            </div>
          {% endif %}
          {% if post_details %}
            <div class="card" style="margin-bottom: 12px;">
              <p class="muted">Per network:</p>
              <ul style="margin: 8px 0 0 16px;">
                {% for row in post_details %}
                  <li class="muted">
                    {{ row.platform }} — {{ row.status }}
                    {% if row.status == 'failed' and row.error %}
                      ({{ row.error }})
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
          {% if error %}
            <div class="card" style="margin-bottom: 12px;">
              <p class="muted">Please add a comment, schedule time, and at least one account.</p>
            </div>
          {% endif %}
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong>{{ selected.title }}</strong>
            </div>
            <div>
              {% if mode == 'reader' %}
                <span class="muted">Reader</span>
                <span class="muted" style="margin: 0 6px;">·</span>
                <a href="{{ base_path }}/articles?{% if active_feed_id %}feed_id={{ active_feed_id }}&{% endif %}selected={{ selected.id }}&mode=original">Original</a>
              {% else %}
                <a href="{{ base_path }}/articles?{% if active_feed_id %}feed_id={{ active_feed_id }}&{% endif %}selected={{ selected.id }}&mode=reader">Reader</a>
                <span class="muted" style="margin: 0 6px;">·</span>
                <span class="muted">Original</span>
              {% endif %}
              <span class="muted" style="margin: 0 6px;">·</span>
              <a href="{{ selected.url }}" target="_blank" rel="noopener">Open in new tab</a>
            </div>
          </div>

          {% if mode == 'original' %}
            <iframe class="inbox__iframe" src="{{ selected.url }}" title="{{ selected.title }}"></iframe>
          {% else %}
            <iframe class="inbox__iframe" src="{{ base_path }}/articles/{{ selected.id }}/embed" title="{{ selected.title }}"></iframe>
          {% endif %}

          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <strong>Schedule</strong>
              <span class="muted" style="font-size: 12px;">{{ selected.feed_name }}</span>
            </div>
            <form method="post" action="{{ base_path }}/posts">
              <input type="hidden" name="_csrf" value="{{ csrf }}" />
              <input type="hidden" name="_submit_token" value="{{ submit_token }}" />
              <input type="hidden" name="article_id" value="{{ selected.id }}" />
              <input type="hidden" name="return_to" value="{{ base_path }}/articles?{% if active_feed_id %}feed_id={{ active_feed_id }}&{% endif %}selected={{ selected.id }}&mode={{ mode }}" />
              <label>
                Comment
                <textarea id="article-comment" name="comment" rows="4" style="width: 100%;"></textarea>
              </label>
              <div class="muted" style="font-size: 12px;">
                Length: <span id="article-comment-length">0</span>
              </div>
              <div style="margin-top: 6px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                <label>
                  Generate
                  <select id="article-generate-mode">
                    <option value="comment">Comment</option>
                    <option value="summary">Summary</option>
                    <option value="phrase">Impactful phrase</option>
                  </select>
                </label>
                <button type="button" data-generate-comment data-article-id="{{ selected.id }}">Generate</button>
                <span class="muted" data-comment-status></span>
              </div>
              <br /><br />
              <label>
                Schedule
                <input id="article-schedule" type="datetime-local" name="scheduled_at" />
              </label>
              <br /><br />
              <fieldset style="border: 0; padding: 0; margin: 0;">
                <legend>Accounts</legend>
                {% if accounts|length == 0 %}
                  <p class="muted">No active accounts yet.</p>
                {% else %}
                  {% for account in accounts %}
                    <label style="display: block;">
                      <input type="checkbox" name="account_ids[]" value="{{ account.id }}" />
                      {{ account.platform }} · {{ account.display_name }} ({{ account.handle }})
                    </label>
                  {% endfor %}
                {% endif %}
              </fieldset>
              <br />
              <button type="submit" name="action" value="schedule">Schedule</button>
              <button type="submit" name="action" value="now" style="margin-left: 6px;">Share now</button>
            </form>
          </div>
        {% else %}
          <div class="muted" style="padding: 24px; border: 1px dashed #eadfce; border-radius: 10px;">
            Select an article to preview and schedule.
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <script>
    (function () {
      var toggle = document.querySelector('.inbox__toggle');
      var list = document.querySelector('.inbox__list');
      if (!toggle || !list) return;

      function applyState() {
        if (window.innerWidth <= 900) {
          var collapsed = list.classList.contains('is-collapsed');
          toggle.style.display = 'inline-flex';
          toggle.textContent = collapsed ? 'Show list' : 'Hide list';
        } else {
          toggle.style.display = 'none';
          list.classList.remove('is-collapsed');
        }
      }

      toggle.addEventListener('click', function () {
        list.classList.toggle('is-collapsed');
        applyState();
      });

      window.addEventListener('resize', applyState);
      applyState();
    })();

    (function () {
      var button = document.querySelector('[data-generate-comment]');
      if (!button) return;
      var status = document.querySelector('[data-comment-status]');
      var textarea = document.getElementById('article-comment');
      var csrf = '{{ csrf }}';
      var basePath = '{{ base_path }}';
      var modeSelect = document.getElementById('article-generate-mode');
      var lengthEl = document.getElementById('article-comment-length');
      var scheduleInput = document.getElementById('article-schedule');

      if (scheduleInput && !scheduleInput.value) {
        var now = new Date(Date.now() + 5 * 60 * 1000);
        scheduleInput.value = now.toISOString().slice(0, 16);
      }

      button.addEventListener('click', function () {
        var articleId = button.getAttribute('data-article-id');
        if (!articleId || !textarea) return;
        button.disabled = true;
        if (status) status.textContent = 'Generating...';
        var body = new URLSearchParams();
        body.set('_csrf', csrf);
        if (modeSelect && modeSelect.value) {
          body.set('mode', modeSelect.value);
        }
        fetch(basePath + '/articles/' + articleId + '/comment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: body.toString()
        })
          .then(function (res) { return res.text(); })
          .then(function (text) {
            textarea.value = text;
            if (lengthEl) lengthEl.textContent = String(text.length);
            if (status) status.textContent = '';
          })
          .catch(function () {
            if (status) status.textContent = 'Failed to generate.';
          })
          .finally(function () {
            button.disabled = false;
          });
      });

      if (textarea && lengthEl) {
        textarea.addEventListener('input', function () {
          lengthEl.textContent = String(textarea.value.length);
        });
      }
    })();
  </script>
{% endblock %}
